name: Fly Deploy

# References:
# * Fly.io CI/CD Docs: https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/
# * flyctl deploy options: flyctl deploy --help

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment (prod or staging)"
        required: false
        default: "prod"
      rollback_image:
        description: "Optional image reference (registry/sha) to rollback to"
        required: false

env:
  # Common build metadata
  COMMIT_SHA: ${{ github.sha }}
  BUILD_TIMESTAMP: ${{ github.run_started_at }}
  PYTHON_VERSION: "3.11"
  FLY_APP_NAME: "genascope-backend"
  # Fail fast on any unhandled error in script blocks
  SHELLOPTS: errexit:pipefail

concurrency:
  group: fly-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_smoke_test:
    name: Build & Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }} (for lightweight validation)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Basic syntax validation (py_compile)
        run: |
          echo "ðŸ”Ž Running lightweight syntax check"
          python - <<'EOF'
import compileall, sys
ok = compileall.compile_dir('.', quiet=1)
sys.exit(0 if ok else 1)
EOF

      - name: Make build script executable
        run: chmod +x build.sh || true

      - name: Build production image (local) for smoke test
        run: |
          ./build.sh prod

      - name: Derive image ID
        id: image_meta
        run: |
          IMAGE_ID=$(docker images --format '{{.Repository}}:{{.Tag}}@{{.ID}}' | grep genascope-backend | head -n1 || true)
          DIGEST=$(docker images --no-trunc --format '{{.ID}}' genascope-backend:prod 2>/dev/null || true)
          echo "image_id=$IMAGE_ID" >> $GITHUB_OUTPUT
          echo "image_digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Image: $IMAGE_ID"

      - name: Run smoke test container
        env:
          # Minimal required env vars for app startup (avoid full secrets usage)
          SECRET_KEY: test-secret-temp
          LAB_API_KEY: test-lab-key
          LAB_API_URL: https://example.com/lab
        run: |
          echo "ðŸš€ Starting container for smoke test"
          docker run -d --rm \
            -e SECRET_KEY \
            -e LAB_API_KEY \
            -e LAB_API_URL \
            -p 8080:8080 \
            --name backend-smoke genascope-backend:prod
          echo "â± Waiting for health endpoint..."
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8080/health >/dev/null 2>&1; then
              echo "âœ… Health check passed"; break; fi; sleep 2;
            if [ $i -eq 30 ]; then echo "âŒ Health check failed"; docker logs backend-smoke; exit 1; fi
          done
          docker logs backend-smoke | tail -n 50
          docker stop backend-smoke

      - name: Upload image metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-metadata
          path: |
            /home/runner/work/_temp/_github_output
          if-no-files-found: ignore

      - name: Summary
        run: |
          echo "### Build & Smoke Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "Image Digest: ${{ steps.image_meta.outputs.image_digest }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to Fly.io
    needs: build_and_smoke_test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout (for fly.toml)
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Decide deployment image mode
        id: deploy_mode
        run: |
          if [ -n "${{ github.event.inputs.rollback_image }}" ]; then
            echo "mode=rollback" >> $GITHUB_OUTPUT
            echo "image_ref=${{ github.event.inputs.rollback_image }}" >> $GITHUB_OUTPUT
          else
            # We'll let Fly do a remote build using the optimized Dockerfile to ensure parity
            echo "mode=remote-build" >> $GITHUB_OUTPUT
          fi

      - name: Rollback to specified image
        if: steps.deploy_mode.outputs.mode == 'rollback'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "ðŸ” Rolling back to image ${{ steps.deploy_mode.outputs.image_ref }}"
          flyctl deploy --image ${{ steps.deploy_mode.outputs.image_ref }} --app $FLY_APP_NAME --strategy immediate --detach

      - name: Remote build & deploy (prod)
        if: steps.deploy_mode.outputs.mode == 'remote-build'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "ðŸš€ Deploying commit $COMMIT_SHA to Fly (remote build)"
          flyctl deploy \
            --app $FLY_APP_NAME \
            --remote-only \
            --build-arg COMMIT_SHA=$COMMIT_SHA \
            --build-arg BUILD_TIMESTAMP=$BUILD_TIMESTAMP \
            --strategy canary \
            --detach

      - name: Post-deploy health check
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "ðŸ”Ž Waiting for allocation health (60s timeout)"
          # Basic check using fly status; can be enhanced with API polling
          for i in {1..12}; do
            if flyctl status --app $FLY_APP_NAME | grep -qi "healthy"; then
              echo "âœ… App reported healthy"; break; fi; sleep 5;
            if [ $i -eq 12 ]; then echo "âŒ App did not become healthy in time"; flyctl status --app $FLY_APP_NAME; exit 1; fi
          done

      - name: Deployment summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "Mode: ${{ steps.deploy_mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "App: $FLY_APP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "Commit: $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY
          echo "Timestamp: $BUILD_TIMESTAMP" >> $GITHUB_STEP_SUMMARY

